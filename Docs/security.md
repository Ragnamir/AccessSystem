# Безопасность

Этот документ описывает механизмы безопасности, реализованные в системе контроля доступа, включая защиту от replay-атак.

## Анти-replay защита

Система реализует защиту от replay-атак (повторного использования перехваченных сообщений) с помощью двух механизмов:

1. **Проверка временного окна (timestamp validation)**
2. **Хранение одноразовых идентификаторов (eventId/nonce)**

### Проверка временного окна

Каждое событие должно содержать поле `timestamp` в формате ISO-8601 (UTC). Система проверяет, что timestamp события находится в допустимом окне отклонения относительно текущего времени сервера.

**Параметры конфигурации:**

- `access-system.anti-replay.timestamp-skew-seconds` - максимальное допустимое отклонение timestamp от текущего времени (в секундах)
  - По умолчанию: `300` (5 минут)
  - Настраивается через переменную окружения: `TIMESTAMP_SKEW_SECONDS`
  
**Логика проверки:**

- Событие принимается, если: `|event_timestamp - current_time| <= timestamp_skew`
- Событие отклоняется, если timestamp находится вне допустимого окна
- Ошибка: `timestamp_out_of_window`

**Примеры:**

- Текущее время: `2025-01-01T12:00:00Z`
- Skew: 300 секунд (5 минут)
- Допустимый диапазон: `[2025-01-01T11:55:00Z, 2025-01-01T12:05:00Z]`
- Событие с timestamp `2025-01-01T11:54:00Z` будет отклонено (слишком старое)
- Событие с timestamp `2025-01-01T12:06:00Z` будет отклонено (слишком новое)

### Хранение одноразовых идентификаторов (eventId/nonce)

Каждое событие должно содержать уникальный идентификатор `eventId` (nonce), который предотвращает повторное использование одного и того же события.

**Параметры конфигурации:**

- `access-system.anti-replay.event-nonce-ttl-seconds` - время жизни eventId в хранилище (в секундах)
  - По умолчанию: `86400` (24 часа)
  - Настраивается через переменную окружения: `EVENT_NONCE_TTL_SECONDS`

**Логика проверки:**

- При получении события система проверяет, не был ли `eventId` уже использован
- Если `eventId` уже существует в хранилище, событие отклоняется как повтор
- Если `eventId` новый, он сохраняется в базу данных с TTL (временем жизни)
- После истечения TTL eventId автоматически удаляется из хранилища
- Ошибка: `duplicate_event_id`

**Стратегия хранения:**

- **Хранилище:** PostgreSQL таблица `event_nonces`
- **Схема таблицы:**
  ```sql
  CREATE TABLE event_nonces (
      event_id        VARCHAR(512) PRIMARY KEY,
      checkpoint_id   VARCHAR(128) NOT NULL,
      event_timestamp TIMESTAMPTZ  NOT NULL,
      expires_at      TIMESTAMPTZ  NOT NULL,
      created_at      TIMESTAMPTZ  NOT NULL DEFAULT NOW()
  );
  ```
- **Индексы:**
  - `event_id` (PRIMARY KEY) - для быстрого поиска дубликатов
  - `checkpoint_id` - для поиска по checkpoint
  - `expires_at` - для очистки истекших записей

**Очистка данных:**

- Система автоматически удаляет истекшие записи при выполнении операций очистки
- Метод `EventNonceRepository.cleanupExpired()` может быть вызван периодически для очистки старых данных
- PostgreSQL индексы оптимизированы для быстрого поиска истекших записей

### Формат запроса

Каждое событие должно содержать обязательное поле `eventId`:

```json
{
  "checkpointId": "cp-1",
  "eventId": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-01-01T12:00:00Z",
  "fromZone": "zone-a",
  "toZone": "zone-b",
  "userToken": "...",
  "signature": "..."
}
```

**Требования к eventId:**

- Обязательное поле (не может быть пустым)
- Должен быть уникальным для каждого события
- Рекомендуется использовать UUID v4
- Длина: до 512 символов

### Порядок проверки

Анти-replay проверки выполняются **до** проверки криптографической подписи, чтобы:

1. Экономить вычислительные ресурсы (не тратить время на криптографические операции для заведомо невалидных событий)
2. Быстро отклонять повторяющиеся или просроченные события
3. Снижать нагрузку на систему при атаках

**Порядок валидации в `/ingest/event`:**

1. Валидация структуры запроса (Bean Validation)
2. **Анти-replay проверка** (timestamp + eventId)
3. Проверка криптографической подписи
4. Проверка пользовательского токена (JWT)
5. Обработка события

### Коды ошибок

**timestamp_out_of_window:**
- HTTP статус: `403 Forbidden`
- Причина: Timestamp события находится вне допустимого окна отклонения
- Ответ:
  ```json
  {
    "status": "rejected",
    "reason": "timestamp_out_of_window",
    "checkpointId": "cp-1",
    "details": "Event timestamp is outside allowed skew window..."
  }
  ```

**duplicate_event_id:**
- HTTP статус: `403 Forbidden`
- Причина: EventId уже был использован ранее (возможная replay-атака)
- Ответ:
  ```json
  {
    "status": "rejected",
    "reason": "duplicate_event_id",
    "checkpointId": "cp-1",
    "details": "Event ID already used (possible replay attack): ..."
  }
  ```

### Рекомендации по настройке

**Для production:**

- `timestamp-skew-seconds`: 300-600 секунд (5-10 минут)
  - Учитывает возможные задержки сети и небольшие рассинхронизации часов
  - Не должен быть слишком большим (риск принятия старых событий)
  
- `event-nonce-ttl-seconds`: 86400-172800 секунд (24-48 часов)
  - Должен покрывать максимальное время возможной задержки доставки события
  - Учитывает возможные проблемы с сетью и восстановление после сбоев
  - Не должен быть слишком большим (рост размера БД)

**Для тестирования:**

- `timestamp-skew-seconds`: 60 секунд (для более строгих тестов)
- `event-nonce-ttl-seconds`: 3600 секунд (1 час)

### Мониторинг и очистка

**Мониторинг:**

- Логирование всех отклоненных событий с причинами
- Метрики для отслеживания количества отклоненных событий по типам
- Алерты при аномально высоком количестве отклоненных событий

**Очистка:**

- Периодическая очистка истекших записей (можно настроить через scheduled task)
- Рекомендуется очистка раз в час или при достижении определенного процента заполнения таблицы

### Миграция БД

Миграция для таблицы `event_nonces` находится в:
- `src/main/resources/db/migration/V4__event_nonces.sql`

Миграция создает таблицу и необходимые индексы для эффективной работы анти-replay защиты.

