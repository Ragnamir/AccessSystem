# Диаграмма последовательностей обработки события

## Сценарий успешного прохода

Диаграмма показывает полный флоу обработки события от получения запроса до фиксации транзакции в базе данных.

### Полный флоу обработки

```
Client                  IngestController          AntiReplayService    CheckpointVerifier    TokenVerifier    TransactionalService    AccessEvaluator    UserStateService    EventRepository    Database
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |  POST /ingest/event        |                            |                    |                    |                    |                    |                    |                    |                    |
  |--------------------------->|                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  validateEvent()           |                    |                    |                    |                    |                    |                    |                    |
  |                            |--------------------------->|                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  ValidationResult          |                    |                    |                    |                    |                    |                    |                    |
  |                            |<---------------------------|                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  verifyCheckpoint()        |                    |                    |                    |                    |                    |                    |                    |
  |                            |------------------------------------------------->|                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  VerificationResult        |                    |                    |                    |                    |                    |                    |                    |
  |                            |<-------------------------------------------------|                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  verifyAndDecodeToken()    |                    |                    |                    |                    |                    |                    |                    |
  |                            |--------------------------------------------------------------------->|                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  TokenVerificationResult   |                    |                    |                    |                    |                    |                    |                    |
  |                            |<---------------------------------------------------------------------|                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  [BEGIN TRANSACTION]       |                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |  processEvent()            |                    |                    |                    |                    |                    |                    |                    |
  |                            |-------------------------------------------------------------------------------------->|                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |  canTransit()      |                    |                    |                    |                    |                    |                    |
  |                            |                            |-------------------------------------------------------------------------------->|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |  AccessDecision     |                    |                    |                    |                    |                    |                    |
  |                            |                            |<--------------------------------------------------------------------------------|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |  updateZone()       |                    |                    |                    |                    |                    |
  |                            |                            |---------------------------------------------------------------->|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |  UPDATE user_state  |                    |                    |                    |                    |
  |                            |                            |                    |<----------------------------------|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |  UPDATE result      |                    |                    |                    |                    |
  |                            |                            |                    |---------------------------------->|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |  recordEvent()      |                    |                    |                    |                    |                    |
  |                            |                            |-------------------------------------------------------------------------------------->|                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |  INSERT INTO events |                    |
  |                            |                            |                    |                    |                    |                    |<----------------------------------|                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |  INSERT result      |                    |
  |                            |                            |                    |                    |                    |                    |---------------------------------->|                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |  [COMMIT TRANSACTION]      |                    |                    |                    |                    |                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |                            |  ProcessingResult          |                    |                    |                    |                    |                    |                    |                    |
  |                            |<--------------------------------------------------------------------------------------|                    |                    |                    |
  |                            |                            |                    |                    |                    |                    |                    |                    |
  |  HTTP 202 Accepted         |                            |                    |                    |                    |                    |                    |                    |                    |
  |<---------------------------|                            |                    |                    |                    |                    |                    |                    |                    |
```

### Описание шагов

1. **Валидация anti-replay** (AntiReplayService)
   - Проверка временного окна timestamp
   - Проверка уникальности eventId

2. **Верификация подписи checkpoint** (CheckpointVerifier)
   - Построение канонической формы payload
   - Проверка криптографической подписи

3. **Верификация токена пользователя** (TokenVerifier)
   - Проверка подписи JWT токена
   - Извлечение user ID из токена

4. **Транзакционная обработка** (TransactionalService) - **ВСЕ В ОДНОЙ ТРАНЗАКЦИИ**:
   - **Проверка доступа** (AccessEvaluator): проверка правил доступа в таблице access_rules
   - **Обновление состояния** (UserStateService): атомарное обновление user_state с оптимистичной блокировкой
   - **Запись события** (EventRepository): запись успешного перехода в таблицу events
   - Все операции выполняются атомарно - либо все успешно, либо все откатываются

### Атомарность транзакции

Все операции внутри `@Transactional` метода выполняются в одной транзакции:
- Если проверка доступа не пройдена → транзакция откатывается, состояние не обновляется, событие не записывается
- Если обновление состояния не удалось → транзакция откатывается, событие не записывается
- Если запись события не удалась → транзакция откатывается, состояние откатывается

Только при успешном выполнении всех операций транзакция фиксируется (COMMIT), и изменения становятся видимыми.

