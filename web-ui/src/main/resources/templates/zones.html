<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Зоны и переходы</title>
    <script src="https://unpkg.com/gojs/release/go.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
        }
        .diagram-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .status-bar {
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #555;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #f44336;
            transition: background-color 0.3s ease;
        }
        .status-dot.online {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
<div class="container">
    <a th:href="@{/}" class="back-link">← Назад к главной</a>
    <h1>Зоны и переходы</h1>
    <div id="diagram" class="diagram-container"></div>
    <div class="status-bar">
        <span class="status-indicator">
            <span id="ws-status" class="status-dot"></span>
            <span id="ws-status-text">WebSocket не подключен</span>
        </span>
        <span id="last-update">Обновлений пока нет</span>
    </div>
</div>
<script>
    (function () {
        const $ = go.GraphObject.make;
        const OUT_ZONE_CODE = "OUT";
        let outZoneKey = OUT_ZONE_CODE;
        const diagram = $(go.Diagram, "diagram", {
            initialAutoScale: go.Diagram.Uniform,
            layout: $(go.LayeredDigraphLayout, {
                direction: 0,
                layerSpacing: 120,
                columnSpacing: 80
            })
        });

        const userTemplate =
            $(go.Panel, "Auto",
                $(go.Shape, "RoundedRectangle", {
                    fill: "#E8F5E9",
                    stroke: "#4CAF50",
                    strokeWidth: 1
                }),
                $(go.TextBlock, {
                    margin: new go.Margin(2, 8, 2, 8),
                    font: "12px Arial, sans-serif",
                    stroke: "#1B5E20"
                }, new go.Binding("text", "label"))
            );

        const defaultNodeTemplate =
            $(go.Node, "Auto",
                $(go.Shape, "RoundedRectangle", {
                    fill: "#ffffff",
                    stroke: "#4CAF50",
                    strokeWidth: 2
                }),
                $(go.Panel, "Vertical",
                    { margin: 10 },
                    $(go.TextBlock, {
                        font: "bold 16px Arial, sans-serif",
                        stroke: "#333"
                    }, new go.Binding("text", "code")),
                    $(go.Panel, "Vertical",
                        {
                            margin: new go.Margin(8, 0, 0, 0),
                            defaultAlignment: go.Spot.Left,
                            itemTemplate: userTemplate
                        },
                        new go.Binding("itemArray", "users"))
                )
            );

        const outZoneTemplate =
            $(go.Node, "Auto",
                {
                    locationSpot: go.Spot.Center,
                    isLayoutPositioned: false,
                    selectable: false,
                    movable: false,
                    cursor: "default"
                },
                new go.Binding("location", "loc", go.Point.parse),
                $(go.Shape, "RoundedRectangle", {
                    fill: "#FFF3E0",
                    stroke: "#FB8C00",
                    strokeWidth: 2
                }),
                $(go.Panel, "Vertical",
                    { margin: 10 },
                    $(go.TextBlock, {
                        font: "bold 16px Arial, sans-serif",
                        stroke: "#E65100"
                    }, new go.Binding("text", "code")),
                    $(go.Panel, "Vertical",
                        {
                            margin: new go.Margin(8, 0, 0, 0),
                            defaultAlignment: go.Spot.Left,
                            itemTemplate: userTemplate
                        },
                        new go.Binding("itemArray", "users"))
                )
            );

        diagram.nodeTemplate = defaultNodeTemplate;
        diagram.nodeTemplateMap.add("outZone", outZoneTemplate);

        diagram.linkTemplate =
            $(go.Link,
                {
                    routing: go.Link.AvoidsNodes,
                    corner: 10,
                    curve: go.Link.JumpGap
                },
                $(go.Shape, { strokeWidth: 2, stroke: "#2196F3" }),
                $(go.Shape, { toArrow: "Standard", stroke: null, fill: "#2196F3" }),
                $(go.Panel, "Auto",
                    $(go.Shape, {
                        fill: "#E3F2FD",
                        stroke: "#2196F3"
                    }),
                    $(go.TextBlock, {
                        margin: 4,
                        font: "12px Arial, sans-serif",
                        stroke: "#0D47A1"
                    }, new go.Binding("text", "code"))
                )
            );

        async function loadGraph() {
            const response = await fetch("/graph");
            if (!response.ok) {
                throw new Error("Не удалось загрузить граф зон");
            }
            const data = await response.json();
            const outZoneData = data.zones.find(zone => zone.code && zone.code.toUpperCase() === OUT_ZONE_CODE) || null;
            outZoneKey = outZoneData ? outZoneData.code : OUT_ZONE_CODE;

            const zoneNodes = data.zones
                .filter(zone => !(zone.code && zone.code.toUpperCase() === OUT_ZONE_CODE))
                .map(zone => ({
                    key: zone.code,
                    code: zone.code,
                    users: []
                }));

            zoneNodes.push({
                key: outZoneKey,
                code: outZoneData ? outZoneData.code : OUT_ZONE_CODE,
                users: [],
                category: "outZone",
                loc: go.Point.stringify(new go.Point(-250, 0))
            });
            const links = data.checkpoints.map(cp => ({
                key: cp.id,
                from: cp.fromZoneCode,
                to: cp.toZoneCode,
                code: cp.code
            }));

            const model = new go.GraphLinksModel(zoneNodes, links);
            model.nodeKeyProperty = "key";
            model.nodeCategoryProperty = "category";
            diagram.model = model;
        }

        function normalizeZoneCode(code) {
            if (!code) {
                return outZoneKey;
            }
            return code.toUpperCase() === outZoneKey.toUpperCase() ? outZoneKey : code;
        }

        function formatUserLabel(user) {
            if (!user.updatedAt) {
                return user.code;
            }
            const updatedDate = new Date(user.updatedAt);
            return `${user.code} · ${updatedDate.toLocaleTimeString()}`;
        }

        function updateUsers(payload) {
            const zoneUsers = new Map();
            (payload.users || []).forEach(user => {
                const zone = normalizeZoneCode(user.zoneCode);
                if (!zoneUsers.has(zone)) {
                    zoneUsers.set(zone, []);
                }
                zoneUsers.get(zone).push({
                    label: formatUserLabel(user),
                    code: user.code
                });
            });

            diagram.model.startTransaction("updateUsers");
            diagram.model.nodeDataArray.forEach(node => {
                const users = zoneUsers.get(node.key) || [];
                diagram.model.setDataProperty(node, "users", users);
            });
            diagram.model.commitTransaction("updateUsers");

            const lastUpdate = document.getElementById("last-update");
            if (lastUpdate) {
                const generatedAt = payload.generatedAt ? new Date(payload.generatedAt) : new Date();
                lastUpdate.textContent = `Последнее обновление: ${generatedAt.toLocaleTimeString()}`;
            }
        }

        function setupWebSocket() {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const url = `${protocol}://${window.location.host}/ws/users`;
            const statusDot = document.getElementById("ws-status");
            const statusText = document.getElementById("ws-status-text");

            function setStatus(online) {
                if (!statusDot || !statusText) {
                    return;
                }
                statusDot.classList.toggle("online", online);
                statusText.textContent = online ? "WebSocket подключен" : "WebSocket не подключен";
            }

            const socket = new WebSocket(url);
            socket.onopen = () => setStatus(true);
            socket.onclose = () => setStatus(false);
            socket.onerror = () => setStatus(false);
            socket.onmessage = event => {
                try {
                    const payload = JSON.parse(event.data);
                    updateUsers(payload);
                } catch (err) {
                    console.error("Ошибка обработки сообщения WebSocket", err);
                }
            };
        }

        loadGraph()
            .then(setupWebSocket)
            .catch(err => {
                console.error(err);
                const lastUpdate = document.getElementById("last-update");
                if (lastUpdate) {
                    lastUpdate.textContent = "Ошибка загрузки графа зон";
                }
            });
    })();
</script>
</body>
</html>


